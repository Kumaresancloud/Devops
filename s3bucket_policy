#!/bin/bash

set -euo pipefail

echo "Fetching buckets with replication enabled and validating roles..."
echo "Bucket Name,Replication Status,Role Name,Policy Attached" > replication_audit.csv

AWS_REGION="us-east-1"
POLICY_ARN="arn:aws:iam::aws:policy/AmazonS3FullAccess"

buckets=$(aws s3api list-buckets --query "Buckets[].Name" --output text)

for bucket in $buckets; do
  replication=$(aws s3api get-bucket-replication --bucket "$bucket" --region "$AWS_REGION" 2>/dev/null)

  if [ $? -eq 0 ]; then
    role_arn=$(echo "$replication" | jq -r '.ReplicationConfiguration.Role')
    role_name=$(basename "$role_arn")

    echo "  ➤ $bucket has replication. Role: $role_name"

    attached_policies=$(aws iam list-attached-role-policies --role-name "$role_name" --query "AttachedPolicies[].PolicyArn" --output text)

    if [[ "$attached_policies" == *"$POLICY_ARN"* ]]; then
      echo "$bucket,Enabled,$role_name,Attached" >> replication_audit.csv
    else
      echo "    ❌ $role_name missing AmazonS3FullAccess. Attaching..."
      aws iam attach-role-policy --role-name "$role_name" --policy-arn "$POLICY_ARN"
      echo "$bucket,Enabled,$role_name,Now Attached" >> replication_audit.csv
    fi
  fi
done

echo "✅ Audit complete. See 'replication_audit.csv'"
